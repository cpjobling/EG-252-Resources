<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Dr K. S. (Joseph) Kim">
  <meta name="author" content="Dr Chris P. Jobling">
  <title>=EG-252 Microntroller Interfacing: Microcontroller Laboratory - Exercise 1: Keyboard Interrupt</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../stylesheets/stylesheet.css">
</head>
<body>

 <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
<h1 class="title">Exercise 1: Keyboard Interrupt</h1>
<h1 class="subtitle">EG-252 Group Design Exercise – Microcontroller Laboratory</h1>
<h1 class="author">
Dr K. S. (Joseph) Kim
</h1>
<h1 class="author">
Dr Chris P. Jobling
</h1>
<h3 class="date">September 2014</h3>
        </header>
    </div>
<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
<section id="main_content" class="inner">
<p>For this exercise you are provided sample keyboard interrupt programs in both C and Assembly in the appendices; make sure that you have downloaded electronic versions of the program from the <a href="https://github.com/cpjobling/EG-252-Resources/tree/master/Microcontroller-Interfacing/Exercises/Exercise1">GitHub repository</a> before the exercise. The program uses the interrupt generated by push buttons to switch on/off the LEDs on the MC9S08AW60 evaluation board.</p>
<p>You are to carry out the following three tasks with this exercise:</p>
<ul>
<li>Use the sample program to practice using interrupt mechanism to interface peripheral devices with the evaluation board.</li>
<li>Answer the questions related to the CPU interrupt procedure (4 marks).</li>
<li>Adjust the sample program to use the onboard switches to control the display of your student number (6 marks).</li>
</ul>
<p>You can view this document as a web page <a href="exercise1.html">HTML</a>, <a href="exercise1.pdf">PDF</a> or as a Word Document <a href="exercise1.docx">.docx</a>.</p>
<h2 id="i.-experiment-with-the-sample-program">I. Experiment with the Sample Program</h2>
<p>The sample program, “<a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise1/kbi_interrupt.c">kbi_interrupt.c</a>” and “<a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise1/kbi_interrupt.asm">kbi_interrupt.asm</a>”, flashes onboard LEDs upon the interrupt requests generated by the keyboard inputs, which are <code>SW3</code> and <code>SW4</code> used as keyboard inputs 6 and 5, respectively. The flowchart of the program is shown in Figure 1. Enter it or copy the electronic file onto your CodeWarrior project, which is created targeting on HCS08 CPU family and MC9S08AW60 MCU.</p>
<figure>
<img src="../Pictures/fig1.png" alt="Figure 1. Flowchart of the keyboard interrupt program" /><figcaption aria-hidden="true">Figure 1. Flowchart of the keyboard interrupt program</figcaption>
</figure>
<p>After you create your own keyboard interrupt project, you can use the evaluation board to debug the sample keyboard interrupt program. Next we will introduce how to use the evaluation board to configure peripheral device inputs and generate interrupts.</p>
<h3 id="a.-interrupt-generation-with-the-evaluation-board">A. Interrupt Generation with the Evaluation Board</h3>
<p>The evaluation board includes four pushbutton switches (<code>SW1</code>-<code>SW4</code>) which can provide momentary active low input for user applications. <code>SW3</code> and <code>SW4</code> are connected to MCU Port <code>PTD3</code> and <code>PTD2</code> respectively. If the pins of <code>PTD3</code> and <code>PTD2</code> are configured as KBI inputs, they will be read with “1” if the corresponding pushbutton is not pressed and “0” if pressed. Edge events and edge/level events can be easily generated by pressing <code>SW3</code> and <code>SW4</code>. The KBI inputs can detect the selected events as configured by the programmer and generate interrupt requests if the keyboard interrupt for the inputs is enabled.</p>
<h3 id="b.-experiment-with-the-interrupt-mechanism">B. Experiment with the Interrupt Mechanism</h3>
<p>Once we know how to generate keyboard interrupt events, we can use the sample program and evaluation board kits to experiment with interrupt mechanism.</p>
<p>According to the interrupt procedure, CPU will leave the main program and run the interrupt service routine (ISR) if interrupt for the keyboard module is enabled. You can use “Single-step” or set breakpoint(s) to observe how the CPU responds to interrupt requests. After the CPU finishes the ISR, it returns to the main program. You can generate as many keyboard-interrupts as you like by pushing down the switches.</p>
<p>You can also experiment with the detection of a rising edge and rising edge/high level events and correspondingly generating keyboard interrupt events by configuring the keyboard interrupt status and control register.</p>
<h2 id="ii.-questions">II. Questions</h2>
<p>By doing experiments with the slightly modified sample C programme, you are required to answer the following questions.</p>
<ol type="1">
<li><p>Upon the generation of keyboard interrupt requests, the ISR will be run by the CPU. Experiment with the evaluation board, record and compare the content in the stack just before and after the CPU enters the ISR and just before and after the CPU leaves the ISR corresponding to a keyboard interrupt. You can get the stack pointer value from the register panel in the real-time debugger window.</p></li>
<li><p>Explain why the stack content changes as you have observed.</p></li>
</ol>
<p>Make a careful note of your observations as you will need them for the assessment later.</p>
<h2 id="iii.-adjust-the-sample-program-to-display-your-student-numbers">III. Adjust the Sample Program to Display your Student Numbers</h2>
<p>All the eight KBI inputs share the KBI source. In this task you are required to adjust the ISR shown in the Appendix, in order to determine which of the two pushbuttons <code>SW3</code> and <code>SW4</code> triggered a KBI interrupt and correspondingly display a student number of a member in your team.</p>
<p>Suppose the student numbers for your team are 43210 and 12345, respectively. On reset, if the pushbutton <code>SW3</code> is pressed down, in your ISR you should light up the leftmost nonzero digit 4 in the first student number over LEDs (i.e., in a binary format using four LEDs). Then the CPU should leave the ISR and return to the main program. If <code>SW3</code> is released and then pressed down again, the next digit 3 in the first student should be displayed over LED in your ISR. With more pressing of SW3, the following digits in the first student number are displayed sequentially. Note that after the rightmost digit 0 was displayed over LEDs upon the last pressing of <code>SW3</code>, the leftmost digit 4 will be displayed over LEDs upon new <code>SW3</code> pressing. Similar operations are performed for the second student number 12345 if the pushbutton <code>SW4</code> is pressed.</p>
<p>You are required to design and debug the ISR program (using the C language), and submit the completed program as a single file named <code>kbi_SN.c</code> (where SN is your student number). The assessment point on Canvas LMS is called <strong>Assessment of Microntrollers Laboratory Exercise 1</strong>.</p>
<h2 id="appendix-a">Appendix A</h2>
<h3 id="sample-program-in-c">Sample Program in C</h3>
<div class="sourceCode" id="kbi_interrupt_c" data-include="kbi_interrupt.c"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="kbi_interrupt_c-1"><a href="#kbi_interrupt_c-1"></a><span class="co">/* kbi_interrupt.c */</span></span>
<span id="kbi_interrupt_c-2"><a href="#kbi_interrupt_c-2"></a></span>
<span id="kbi_interrupt_c-3"><a href="#kbi_interrupt_c-3"></a><span class="pp">#include </span><span class="im">&lt;hidef.h&gt;</span><span class="pp">	 </span><span class="co">/* for EnableInterrupts macro */</span></span>
<span id="kbi_interrupt_c-4"><a href="#kbi_interrupt_c-4"></a><span class="pp">#include </span><span class="im">&quot;derivative.h&quot;</span><span class="pp">	</span><span class="co">/* include peripheral declarations */</span></span>
<span id="kbi_interrupt_c-5"><a href="#kbi_interrupt_c-5"></a><span class="pp">#define VNkeyboard 22   </span><span class="co">/* Interrupt vector for Keyboard */</span></span>
<span id="kbi_interrupt_c-6"><a href="#kbi_interrupt_c-6"></a></span>
<span id="kbi_interrupt_c-7"><a href="#kbi_interrupt_c-7"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">char</span> muint8;</span>
<span id="kbi_interrupt_c-8"><a href="#kbi_interrupt_c-8"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">short</span> muint16;</span>
<span id="kbi_interrupt_c-9"><a href="#kbi_interrupt_c-9"></a><span class="kw">typedef</span> <span class="dt">unsigned</span> <span class="dt">long</span> muint32;</span>
<span id="kbi_interrupt_c-10"><a href="#kbi_interrupt_c-10"></a></span>
<span id="kbi_interrupt_c-11"><a href="#kbi_interrupt_c-11"></a><span class="kw">typedef</span> <span class="dt">char</span> mint8;</span>
<span id="kbi_interrupt_c-12"><a href="#kbi_interrupt_c-12"></a><span class="kw">typedef</span> <span class="dt">short</span> mint16;</span>
<span id="kbi_interrupt_c-13"><a href="#kbi_interrupt_c-13"></a><span class="kw">typedef</span> <span class="dt">long</span> mint32;</span>
<span id="kbi_interrupt_c-14"><a href="#kbi_interrupt_c-14"></a></span>
<span id="kbi_interrupt_c-15"><a href="#kbi_interrupt_c-15"></a>muint8 LED_onseq;</span>
<span id="kbi_interrupt_c-16"><a href="#kbi_interrupt_c-16"></a></span>
<span id="kbi_interrupt_c-17"><a href="#kbi_interrupt_c-17"></a><span class="dt">void</span> main(<span class="dt">void</span>) </span>
<span id="kbi_interrupt_c-18"><a href="#kbi_interrupt_c-18"></a>{</span>
<span id="kbi_interrupt_c-19"><a href="#kbi_interrupt_c-19"></a></span>
<span id="kbi_interrupt_c-20"><a href="#kbi_interrupt_c-20"></a>	SOPT = <span class="bn">0x00</span>;		<span class="co">/* disable COP */</span></span>
<span id="kbi_interrupt_c-21"><a href="#kbi_interrupt_c-21"></a></span>
<span id="kbi_interrupt_c-22"><a href="#kbi_interrupt_c-22"></a>	<span class="co">/* begin LED/switch test */</span></span>
<span id="kbi_interrupt_c-23"><a href="#kbi_interrupt_c-23"></a></span>
<span id="kbi_interrupt_c-24"><a href="#kbi_interrupt_c-24"></a>	PTDPE = <span class="bn">0xFF</span>;		<span class="co">/* enable port D pullups for push button switch interrupt */</span></span>
<span id="kbi_interrupt_c-25"><a href="#kbi_interrupt_c-25"></a></span>
<span id="kbi_interrupt_c-26"><a href="#kbi_interrupt_c-26"></a>	<span class="co">/* Init_GPIO init code */</span></span>
<span id="kbi_interrupt_c-27"><a href="#kbi_interrupt_c-27"></a>	PTFDD = <span class="bn">0xFF</span>;		<span class="co">/* set port F as outputs for LED operation */</span></span>
<span id="kbi_interrupt_c-28"><a href="#kbi_interrupt_c-28"></a>	LED_onseq = <span class="bn">0x0F</span>;	<span class="co">/* initialize LED_onseq */</span></span>
<span id="kbi_interrupt_c-29"><a href="#kbi_interrupt_c-29"></a></span>
<span id="kbi_interrupt_c-30"><a href="#kbi_interrupt_c-30"></a>	<span class="co">//*********************************************************************************</span></span>
<span id="kbi_interrupt_c-31"><a href="#kbi_interrupt_c-31"></a>	<span class="co">//* KBI1PE7 * KBI1PE6 * KBI1PE5 * KBI1PE4 * KBI1PE3 * KBI1PE2 * KBI1PE1 * KBI1PE0 *</span></span>
<span id="kbi_interrupt_c-32"><a href="#kbi_interrupt_c-32"></a>	<span class="co">//*********************************************************************************	</span></span>
<span id="kbi_interrupt_c-33"><a href="#kbi_interrupt_c-33"></a>	<span class="co">// KBI1PE register; each bit selects the corresponding keyboard interrupt pin.</span></span>
<span id="kbi_interrupt_c-34"><a href="#kbi_interrupt_c-34"></a></span>
<span id="kbi_interrupt_c-35"><a href="#kbi_interrupt_c-35"></a>	<span class="co">//*********************************************************************************</span></span>
<span id="kbi_interrupt_c-36"><a href="#kbi_interrupt_c-36"></a>	<span class="co">//* KBEDG7  * KBEDG6  * KBEDG5  * KBEDG4  *   KBF   *  KBACK  *  KBIE   *  KBIMOD *</span></span>
<span id="kbi_interrupt_c-37"><a href="#kbi_interrupt_c-37"></a>	<span class="co">//*********************************************************************************</span></span>
<span id="kbi_interrupt_c-38"><a href="#kbi_interrupt_c-38"></a>	<span class="co">// KBI1SC register; top four bits 0 = falling edge 1 = rising edge of corresponding</span></span>
<span id="kbi_interrupt_c-39"><a href="#kbi_interrupt_c-39"></a>	<span class="co">// pins KBEDG7 to 4. KBF keyboard interrupt flag, KBACK acknowledges interrupt flag.</span></span>
<span id="kbi_interrupt_c-40"><a href="#kbi_interrupt_c-40"></a>	<span class="co">// KBIE turns on the keyboard interrupt system, KBIMOD 0 = edge detection.</span></span>
<span id="kbi_interrupt_c-41"><a href="#kbi_interrupt_c-41"></a></span>
<span id="kbi_interrupt_c-42"><a href="#kbi_interrupt_c-42"></a>	KBI1SC_KBIE = <span class="dv">0</span>;	<span class="co">//Make sure interrupt is OFF</span></span>
<span id="kbi_interrupt_c-43"><a href="#kbi_interrupt_c-43"></a>	KBI1PE = <span class="bn">0b01100000</span>;	<span class="co">//Turn on interrupts for pins 5 and 6 only</span></span>
<span id="kbi_interrupt_c-44"><a href="#kbi_interrupt_c-44"></a>	KBI1SC_KBIMOD = <span class="dv">0</span>;	<span class="co">//Make sure we are on edge operation</span></span>
<span id="kbi_interrupt_c-45"><a href="#kbi_interrupt_c-45"></a>	KBI1SC_KBACK = <span class="dv">1</span>;	<span class="co">//Clear any possible pending interrupts</span></span>
<span id="kbi_interrupt_c-46"><a href="#kbi_interrupt_c-46"></a>	KBI1SC_KBIE = <span class="dv">1</span>;	<span class="co">//Turn on selected keyboard interrupts</span></span>
<span id="kbi_interrupt_c-47"><a href="#kbi_interrupt_c-47"></a></span>
<span id="kbi_interrupt_c-48"><a href="#kbi_interrupt_c-48"></a>	EnableInterrupts;	<span class="co">// enable interrupts globally (&quot;big switch&quot;)</span></span>
<span id="kbi_interrupt_c-49"><a href="#kbi_interrupt_c-49"></a></span>
<span id="kbi_interrupt_c-50"><a href="#kbi_interrupt_c-50"></a>	<span class="cf">for</span>(;;) </span>
<span id="kbi_interrupt_c-51"><a href="#kbi_interrupt_c-51"></a>	{</span>
<span id="kbi_interrupt_c-52"><a href="#kbi_interrupt_c-52"></a></span>
<span id="kbi_interrupt_c-53"><a href="#kbi_interrupt_c-53"></a>	}	<span class="co">/* loop forever */</span></span>
<span id="kbi_interrupt_c-54"><a href="#kbi_interrupt_c-54"></a>		<span class="co">/* make sure that you never leave main! */</span></span>
<span id="kbi_interrupt_c-55"><a href="#kbi_interrupt_c-55"></a>}</span>
<span id="kbi_interrupt_c-56"><a href="#kbi_interrupt_c-56"></a></span>
<span id="kbi_interrupt_c-57"><a href="#kbi_interrupt_c-57"></a><span class="co">// What follows is the interrupt service routine, which is called if either of the</span></span>
<span id="kbi_interrupt_c-58"><a href="#kbi_interrupt_c-58"></a><span class="co">// selected keyboard interrupts occurs on pins 5 and 6. However, Port D is tested</span></span>
<span id="kbi_interrupt_c-59"><a href="#kbi_interrupt_c-59"></a><span class="co">// and the LED toggle only happens if SW3 is pressed. (KBI 6, Port D3).</span></span>
<span id="kbi_interrupt_c-60"><a href="#kbi_interrupt_c-60"></a></span>
<span id="kbi_interrupt_c-61"><a href="#kbi_interrupt_c-61"></a>interrupt VNkeyboard <span class="dt">void</span> intKBI_SW()</span>
<span id="kbi_interrupt_c-62"><a href="#kbi_interrupt_c-62"></a>{</span>
<span id="kbi_interrupt_c-63"><a href="#kbi_interrupt_c-63"></a>	KBI1SC_KBACK = <span class="dv">1</span>;		<span class="co">// acknowledge interrupt</span></span>
<span id="kbi_interrupt_c-64"><a href="#kbi_interrupt_c-64"></a>	<span class="co">// this is the business of the interrupt</span></span>
<span id="kbi_interrupt_c-65"><a href="#kbi_interrupt_c-65"></a>	<span class="cf">if</span> (PTDD_PTDD3 == <span class="dv">0</span>)</span>
<span id="kbi_interrupt_c-66"><a href="#kbi_interrupt_c-66"></a>	{</span>
<span id="kbi_interrupt_c-67"><a href="#kbi_interrupt_c-67"></a>		PTFD = LED_onseq;	</span>
<span id="kbi_interrupt_c-68"><a href="#kbi_interrupt_c-68"></a>		LED_onseq ^= <span class="bn">0xFF</span>;	<span class="co">// toggle LED_onseq bits</span></span>
<span id="kbi_interrupt_c-69"><a href="#kbi_interrupt_c-69"></a>	}	</span>
<span id="kbi_interrupt_c-70"><a href="#kbi_interrupt_c-70"></a>	<span class="co">// do nothing if not keyboard interrupt VNkeyboard</span></span>
<span id="kbi_interrupt_c-71"><a href="#kbi_interrupt_c-71"></a>}</span></code></pre></div>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise1/kbi_interrupt.c">GitHub</a></p>
<h2 id="appendix-b">Appendix B</h2>
<h3 id="sample-program-in-assembly">Sample Program in Assembly</h3>
<div class="sourceCode" id="kbi_interrupt_asm" data-include="kbi_interrupt.asm"><pre class="sourceCode numberSource assembly numberLines"><code class="sourceCode"><span id="kbi_interrupt_asm-1"><a href="#kbi_interrupt_asm-1"></a>;*************************************************************************</span>
<span id="kbi_interrupt_asm-2"><a href="#kbi_interrupt_asm-2"></a>;*	kbi_adc.asm                                                      *</span>
<span id="kbi_interrupt_asm-3"><a href="#kbi_interrupt_asm-3"></a>;*                                                                       *</span>
<span id="kbi_interrupt_asm-4"><a href="#kbi_interrupt_asm-4"></a>;*	MC9S08AW60 Evaluation board keyboard interrupt example           *</span>
<span id="kbi_interrupt_asm-5"><a href="#kbi_interrupt_asm-5"></a>;*	- Switch SW3 onboard connected to Port D bit 3, KBI pin6;        *</span>
<span id="kbi_interrupt_asm-6"><a href="#kbi_interrupt_asm-6"></a>;*	- Switch SW4 onboard connected to Port D bit 2, KBI pin5         *</span>
<span id="kbi_interrupt_asm-7"><a href="#kbi_interrupt_asm-7"></a>;*                                                                       *</span>
<span id="kbi_interrupt_asm-8"><a href="#kbi_interrupt_asm-8"></a>;*	Function:                                                        *</span>
<span id="kbi_interrupt_asm-9"><a href="#kbi_interrupt_asm-9"></a>;*	On reset, all LEDs are off. When either SW3 or SW4 are pressed,  *</span>
<span id="kbi_interrupt_asm-10"><a href="#kbi_interrupt_asm-10"></a>;*	then the ADC channel 8 is read and sent to the LEDs.             *</span>
<span id="kbi_interrupt_asm-11"><a href="#kbi_interrupt_asm-11"></a>;*************************************************************************</span>
<span id="kbi_interrupt_asm-12"><a href="#kbi_interrupt_asm-12"></a></span>
<span id="kbi_interrupt_asm-13"><a href="#kbi_interrupt_asm-13"></a>		INCLUDE	&#39;derivative.inc&#39; ; Include derivative-specific definitions</span>
<span id="kbi_interrupt_asm-14"><a href="#kbi_interrupt_asm-14"></a></span>
<span id="kbi_interrupt_asm-15"><a href="#kbi_interrupt_asm-15"></a>FLASH		EQU		$2000</span>
<span id="kbi_interrupt_asm-16"><a href="#kbi_interrupt_asm-16"></a>RAM		    EQU		$0070</span>
<span id="kbi_interrupt_asm-17"><a href="#kbi_interrupt_asm-17"></a>WATCH		EQU		$1802</span>
<span id="kbi_interrupt_asm-18"><a href="#kbi_interrupt_asm-18"></a></span>
<span id="kbi_interrupt_asm-19"><a href="#kbi_interrupt_asm-19"></a>ConvComp	EQU		%10000000	;Mask for Conversion Complete flag</span>
<span id="kbi_interrupt_asm-20"><a href="#kbi_interrupt_asm-20"></a></span>
<span id="kbi_interrupt_asm-21"><a href="#kbi_interrupt_asm-21"></a>		ORG		RAM</span>
<span id="kbi_interrupt_asm-22"><a href="#kbi_interrupt_asm-22"></a>LED_on		DS.B		1		; Define a variable VAR_D with a size of 1 byte</span>
<span id="kbi_interrupt_asm-23"><a href="#kbi_interrupt_asm-23"></a></span>
<span id="kbi_interrupt_asm-24"><a href="#kbi_interrupt_asm-24"></a>;Start program after reset</span>
<span id="kbi_interrupt_asm-25"><a href="#kbi_interrupt_asm-25"></a></span>
<span id="kbi_interrupt_asm-26"><a href="#kbi_interrupt_asm-26"></a>		ORG		FLASH</span>
<span id="kbi_interrupt_asm-27"><a href="#kbi_interrupt_asm-27"></a>START_UP</span>
<span id="kbi_interrupt_asm-28"><a href="#kbi_interrupt_asm-28"></a>		LDA		#$00</span>
<span id="kbi_interrupt_asm-29"><a href="#kbi_interrupt_asm-29"></a>		STA		WATCH		; Turn off the watchdog timer</span>
<span id="kbi_interrupt_asm-30"><a href="#kbi_interrupt_asm-30"></a>		</span>
<span id="kbi_interrupt_asm-31"><a href="#kbi_interrupt_asm-31"></a>;Init_GPIO init code </span>
<span id="kbi_interrupt_asm-32"><a href="#kbi_interrupt_asm-32"></a>		LDA     	#$FF</span>
<span id="kbi_interrupt_asm-33"><a href="#kbi_interrupt_asm-33"></a>		STA     	PTFDD</span>
<span id="kbi_interrupt_asm-34"><a href="#kbi_interrupt_asm-34"></a>		MOV    		#$0F, LED_on	; Initialize VAR_D, used to control the LEDs</span>
<span id="kbi_interrupt_asm-35"><a href="#kbi_interrupt_asm-35"></a>		LDA     	#$FF</span>
<span id="kbi_interrupt_asm-36"><a href="#kbi_interrupt_asm-36"></a>		STA    		PTDPE           ; Port D is enabled with pull-up</span>
<span id="kbi_interrupt_asm-37"><a href="#kbi_interrupt_asm-37"></a>		RSP				; Reset stack pointer to $0080</span>
<span id="kbi_interrupt_asm-38"><a href="#kbi_interrupt_asm-38"></a>                </span>
<span id="kbi_interrupt_asm-39"><a href="#kbi_interrupt_asm-39"></a>;Enable interrupt for Keyboard input</span>
<span id="kbi_interrupt_asm-40"><a href="#kbi_interrupt_asm-40"></a>		LDA     	#$60</span>
<span id="kbi_interrupt_asm-41"><a href="#kbi_interrupt_asm-41"></a>		STA     	KBI1PE           ; KBI1PE: enable KBI function for pins 5 and 6 only</span>
<span id="kbi_interrupt_asm-42"><a href="#kbi_interrupt_asm-42"></a>		BSET    	$02, KBI1SC      ; KBI1SC: KBACK=1, to clear KBI flag </span>
<span id="kbi_interrupt_asm-43"><a href="#kbi_interrupt_asm-43"></a>		BSET    	$01, KBI1SC      ; KBI1SC: KBIE=1, enable KBI </span>
<span id="kbi_interrupt_asm-44"><a href="#kbi_interrupt_asm-44"></a>                               </span>
<span id="kbi_interrupt_asm-45"><a href="#kbi_interrupt_asm-45"></a>		CLI                      	; Enable interrupt</span>
<span id="kbi_interrupt_asm-46"><a href="#kbi_interrupt_asm-46"></a></span>
<span id="kbi_interrupt_asm-47"><a href="#kbi_interrupt_asm-47"></a>MAINLOOP</span>
<span id="kbi_interrupt_asm-48"><a href="#kbi_interrupt_asm-48"></a>		LDA     	LED_on           ; Simple loop with &quot;dummy&quot; operation</span>
<span id="kbi_interrupt_asm-49"><a href="#kbi_interrupt_asm-49"></a>		BRA		    MAINLOOP</span>
<span id="kbi_interrupt_asm-50"><a href="#kbi_interrupt_asm-50"></a>		</span>
<span id="kbi_interrupt_asm-51"><a href="#kbi_interrupt_asm-51"></a>;Interrupt service routine for a keyboard interrupt generated upon the press of a pushbutton</span>
<span id="kbi_interrupt_asm-52"><a href="#kbi_interrupt_asm-52"></a>;with a falling edge (transition from high logic level &quot;1&quot; to low logic level &quot;0&quot;)                </span>
<span id="kbi_interrupt_asm-53"><a href="#kbi_interrupt_asm-53"></a>LED_SWITCH</span>
<span id="kbi_interrupt_asm-54"><a href="#kbi_interrupt_asm-54"></a>		BSET    	$02, KBI1SC     ; Clear KBI flag </span>
<span id="kbi_interrupt_asm-55"><a href="#kbi_interrupt_asm-55"></a>		LDA     	#8		; Select analogue input 8 (the blue potentiometer).</span>
<span id="kbi_interrupt_asm-56"><a href="#kbi_interrupt_asm-56"></a>		STA     	ADC1SC1         ; ADC conversion will start after a number is written to ADC1SC1 register.</span>
<span id="kbi_interrupt_asm-57"><a href="#kbi_interrupt_asm-57"></a>ADCLOOP                </span>
<span id="kbi_interrupt_asm-58"><a href="#kbi_interrupt_asm-58"></a>		LDA     	ADC1SC1         ; </span>
<span id="kbi_interrupt_asm-59"><a href="#kbi_interrupt_asm-59"></a>		AND		    #ConvComp	    ; Check the COCO bit (conversion complete flag).</span>
<span id="kbi_interrupt_asm-60"><a href="#kbi_interrupt_asm-60"></a>		BEQ     	ADCLOOP         ; if not complete, wait in the ADC loop.</span>
<span id="kbi_interrupt_asm-61"><a href="#kbi_interrupt_asm-61"></a>		LDA     	ADC1RL          ; if complete, read the ADC outcome (digital value) from the register.</span>
<span id="kbi_interrupt_asm-62"><a href="#kbi_interrupt_asm-62"></a>		STA     	PTFD            ; display over LED bar</span>
<span id="kbi_interrupt_asm-63"><a href="#kbi_interrupt_asm-63"></a>		RTI                </span>
<span id="kbi_interrupt_asm-64"><a href="#kbi_interrupt_asm-64"></a></span>
<span id="kbi_interrupt_asm-65"><a href="#kbi_interrupt_asm-65"></a>;INT_VECTOR		</span>
<span id="kbi_interrupt_asm-66"><a href="#kbi_interrupt_asm-66"></a>		ORG     	$FFD2</span>
<span id="kbi_interrupt_asm-67"><a href="#kbi_interrupt_asm-67"></a>		DC.W    	LED_SWITCH</span>
<span id="kbi_interrupt_asm-68"><a href="#kbi_interrupt_asm-68"></a>		</span>
<span id="kbi_interrupt_asm-69"><a href="#kbi_interrupt_asm-69"></a>		ORG    		$FFFE</span>
<span id="kbi_interrupt_asm-70"><a href="#kbi_interrupt_asm-70"></a>		DC.W    	START_UP</span>
<span id="kbi_interrupt_asm-71"><a href="#kbi_interrupt_asm-71"></a></span>
<span id="kbi_interrupt_asm-72"><a href="#kbi_interrupt_asm-72"></a></span>
<span id="kbi_interrupt_asm-73"><a href="#kbi_interrupt_asm-73"></a></span>
<span id="kbi_interrupt_asm-74"><a href="#kbi_interrupt_asm-74"></a></span>
<span id="kbi_interrupt_asm-75"><a href="#kbi_interrupt_asm-75"></a></span></code></pre></div>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise1/kbi_interrupt.asm">GitHub</a></p>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">EG-252 Resources</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.swan.ac.uk" property="cc:attributionName" rel="cc:attributionURL">Swansea University</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.

</div>
</section>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">EG-252-Resources maintained by <a href="https://github.com/cpjobling">cpjobling</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

</body>
</html>

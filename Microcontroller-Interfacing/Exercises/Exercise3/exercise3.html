<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Dr K. S. (Joseph) Kim">
  <meta name="author" content="Dr Chris P. Jobling">
  <title>=EG-252 Microcontroller Interfacing: Microcontroller Laboratory - Exercise 3: Timer and Pulse Width Modulation (TPM) Module</title>
  <style type="text/css">code{white-space: pre;}</style>
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../stylesheets/stylesheet.css">
</head>
<body>

 <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
<h1 class="title">Exercise 3: Timer and Pulse Width Modulation (TPM) Module</h1>
<h1 class="subtitle">EG-252 Group Design Exercise – Microcontroller Laboratory</h1>
<h1 class="author">
Dr K. S. (Joseph) Kim
</h1>
<h1 class="author">
Dr Chris P. Jobling
</h1>
<h3 class="date">September 2020</h3>
        </header>
    </div>
<!-- MAIN CONTENT -->
<div id="main_content_wrap" class="outer">
<section id="main_content" class="inner">
<p>This exercise is designed for understanding of the TPM modules of MC9S08AW60 MCU and the practice of the control of TPM registers in C programming. For this exercise you will be provided with two sample C programs, one for generating a delay by the timer function and the other for pulse-width modulation (PWM) signals for driving motor, respectively. Electronic versions of the programs can be downloaded from the BlackBoard. You are to carry out the following tasks with this exercise:</p>
<ul>
<li>Use the sample program “tpm_timer.c” to understand configurations of and programming with the TPM module 1 (TPM1) registers for timer function.</li>
<li>Modify the sample program “tpm_timer.c” to generate a delay by configuring the TPM module 2 (TPM2) registers.</li>
<li>Use the sample program “tpm_motor.c” to understand how to generate PWM signals to drive two DC motors on the demonstration board with speed and direction control.</li>
<li>Modify the sample program “tpm_motor.c” to set PWM duty cycle and implement independent motor speed control for the two DC motors.</li>
</ul>
<p>This exercise is worth 14 Marks. You should keep careful records of your solutions as you will need to upload your completed programmes and answer questions to gain the credits.</p>
<p>You can view this document as a web page <a href="exercise3.html">HTML</a>, <a href="exercise3.pdf">PDF</a> or as a Word Document <a href="exercise3.docx">.docx</a></p>
<h2 id="i.-task-1-experiment-with-sample-program-tpm_timer.c">I. Task 1: Experiment with Sample Program “<a href="https://github.com/cpjobling/EG-252-Resources/tree/master/Microcontroller-Interfacing/Exercises/Exercise3/tpm_timer.c">tpm_timer.c</a>”</h2>
<p>This sample C program is designed to display 5 digits included in the student number 12345 over the LED bar. Each digit is displayed for a configured time, which is determined by the timer modulo registers <code>TPM1MODH</code>:<code>TPM1MODL</code> of the TPM1 module (lines 19 and 20). An interrupt is generated upon the timer overflow, which is configured through the TPM1 status and control register <code>TPM1SC</code> (line 18). More details on the registers and their configurations are referred to the Freescale MC9S08AW60 datasheet document, Chapter 10 for Timer/PWM.</p>
<p>Once the timer overflow interrupt is generated, the corresponding interrupt service routine, i.e., <code>TPM1_overflow()</code> in this example, will be executed. This interrupt service routine is associated to the timer overflow interrupt by preceding the designated word “interrupt” and followed by the timer overflow interrupt vector “11” in line 28. The interrupt vectors associated with various interrupt sources can be obtained from the Freescale MC9S08AW60 datasheet.</p>
<p>The lines 32 and 33 are a two-step procedure to clear the timer overflow flag (TOF) in the <code>TPM1SC</code> register. Note that once the TOF is set, it will not be automatically cleared. If the TOF is not cleared, the timer overflow routine <code>TPM1_overflow</code> (line 28) will be continuously called. The following method introduced in the MC9S08AW60 datasheet should be used to clear the overflow flag:</p>
<ul>
<li><p>Line 32: Read the TOF (<code>TPM1SC_TOF</code> as we are using the TPM1 module). Note that you can address a register or a specific bit in a register using the name of that register or that bit in a register. Their names can be obtained from the MC9S08AW60 datasheet. For sample, if you want to read the content of TPM1SC register, you can use “<code>varTOF = TPM1SC;</code> if you want to read the content of THE TOF flag in the <code>TMP1SC</code> register, you can simply use”<code>varTOF = TPM1SC_TOF</code>". The registers and flags that can be recognized by CodeWarrior are highlighted by blue colour in the editor window.</p></li>
<li><p>Line 33: Write a zero to the overflow flag TOF by “<code>TPM1SC_TOF = 0</code>”</p></li>
</ul>
<div class="sourceCode" id="tpm_timer_c" data-include="tpm_timer.c"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="tpm_timer_c-1"><a href="#tpm_timer_c-1"></a><span class="pp">#include </span><span class="im">&lt;hidef.h&gt;</span><span class="pp">		</span><span class="co">// for EnableInterrupts macro</span></span>
<span id="tpm_timer_c-2"><a href="#tpm_timer_c-2"></a><span class="pp">#include </span><span class="im">&quot;derivative.h&quot;</span><span class="pp">	</span><span class="co">// include peripheral declarations</span></span>
<span id="tpm_timer_c-3"><a href="#tpm_timer_c-3"></a></span>
<span id="tpm_timer_c-4"><a href="#tpm_timer_c-4"></a>byte tof_cnt, period;</span>
<span id="tpm_timer_c-5"><a href="#tpm_timer_c-5"></a>byte student_num[<span class="dv">5</span>] = {<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>};</span>
<span id="tpm_timer_c-6"><a href="#tpm_timer_c-6"></a>byte digit_cnt = <span class="dv">5</span>;</span>
<span id="tpm_timer_c-7"><a href="#tpm_timer_c-7"></a></span>
<span id="tpm_timer_c-8"><a href="#tpm_timer_c-8"></a><span class="dt">void</span> main(<span class="dt">void</span>)</span>
<span id="tpm_timer_c-9"><a href="#tpm_timer_c-9"></a>{</span>
<span id="tpm_timer_c-10"><a href="#tpm_timer_c-10"></a>    EnableInterrupts;	<span class="co">// enable interrupts</span></span>
<span id="tpm_timer_c-11"><a href="#tpm_timer_c-11"></a>    SOPT   = <span class="bn">0x00</span>;		<span class="co">// disable COP (watchtimer)</span></span>
<span id="tpm_timer_c-12"><a href="#tpm_timer_c-12"></a></span>
<span id="tpm_timer_c-13"><a href="#tpm_timer_c-13"></a>    <span class="co">// Init_GPIO init code </span></span>
<span id="tpm_timer_c-14"><a href="#tpm_timer_c-14"></a>    PTFDD = <span class="bn">0xFF</span>;		<span class="co">// configure port F as outputs for LEDs</span></span>
<span id="tpm_timer_c-15"><a href="#tpm_timer_c-15"></a></span>
<span id="tpm_timer_c-16"><a href="#tpm_timer_c-16"></a>    <span class="co">// configure TPM module 1</span></span>
<span id="tpm_timer_c-17"><a href="#tpm_timer_c-17"></a>    TPM1SC = <span class="bn">0x4F</span>;		<span class="co">// format: TOF(0) TOIE(1) CPWMS(0) CLKSB(0) CLKSA(1) PS2(1) PS1(1) PS0(1)</span></span>
<span id="tpm_timer_c-18"><a href="#tpm_timer_c-18"></a>    TPM1MODH = <span class="bn">0xFF</span>;	<span class="co">// set the counter modulo registers</span></span>
<span id="tpm_timer_c-19"><a href="#tpm_timer_c-19"></a>    TPM1MODL = <span class="bn">0xFF</span>;</span>
<span id="tpm_timer_c-20"><a href="#tpm_timer_c-20"></a></span>
<span id="tpm_timer_c-21"><a href="#tpm_timer_c-21"></a>    tof_cnt = <span class="dv">0</span>;  <span class="co">// initialize the number of timer overflow to 0.</span></span>
<span id="tpm_timer_c-22"><a href="#tpm_timer_c-22"></a>  </span>
<span id="tpm_timer_c-23"><a href="#tpm_timer_c-23"></a>    <span class="cf">for</span>(;;) {</span>
<span id="tpm_timer_c-24"><a href="#tpm_timer_c-24"></a>    }	<span class="co">// loop forever</span></span>
<span id="tpm_timer_c-25"><a href="#tpm_timer_c-25"></a>}</span>
<span id="tpm_timer_c-26"><a href="#tpm_timer_c-26"></a></span>
<span id="tpm_timer_c-27"><a href="#tpm_timer_c-27"></a>interrupt <span class="dv">11</span> <span class="dt">void</span> TPM1_overflow()</span>
<span id="tpm_timer_c-28"><a href="#tpm_timer_c-28"></a>{</span>
<span id="tpm_timer_c-29"><a href="#tpm_timer_c-29"></a>    byte  varTOF;</span>
<span id="tpm_timer_c-30"><a href="#tpm_timer_c-30"></a>   </span>
<span id="tpm_timer_c-31"><a href="#tpm_timer_c-31"></a>    varTOF = TPM1SC_TOF;	<span class="co">// clear TOF; first read and then write 0 to the flag</span></span>
<span id="tpm_timer_c-32"><a href="#tpm_timer_c-32"></a>    TPM1SC_TOF = <span class="dv">0</span>;</span>
<span id="tpm_timer_c-33"><a href="#tpm_timer_c-33"></a>   </span>
<span id="tpm_timer_c-34"><a href="#tpm_timer_c-34"></a>    <span class="cf">if</span> (tof_cnt &gt; digit_cnt) {</span>
<span id="tpm_timer_c-35"><a href="#tpm_timer_c-35"></a>        tof_cnt = <span class="dv">0</span>;		<span class="co">// reset tof_cnt if larger than digit_cnt</span></span>
<span id="tpm_timer_c-36"><a href="#tpm_timer_c-36"></a>    }</span>
<span id="tpm_timer_c-37"><a href="#tpm_timer_c-37"></a></span>
<span id="tpm_timer_c-38"><a href="#tpm_timer_c-38"></a>    PTFD = student_num[tof_cnt];</span>
<span id="tpm_timer_c-39"><a href="#tpm_timer_c-39"></a>    tof_cnt++;</span>
<span id="tpm_timer_c-40"><a href="#tpm_timer_c-40"></a>}</span></code></pre></div>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise3/tpm_timer.c">GitHub</a>"</p>
<p>Listing 1. Sample program for TPM timer function.</p>
<h2 id="ii.-task-2-modify-the-sample-program-to-display-your-student-number">II. Task 2: Modify the Sample Program to Display your Student Number</h2>
<p>For this task you are required to display all the digits in your student number.</p>
<ul>
<li>Each digit needs to be displayed for approximately one second. You can control the modulo registers to generate the desired delay.</li>
<li>Instead of using the TPM1 module, you are required to use the TPM2 module to generate the delay. Your job is to find correct TPM registers to use and configure them accordingly. This task is worth 5 marks.</li>
</ul>
<h1 id="iii.-task-3-experiment-with-sample-program-tpm_motor.c">III. Task 3: Experiment with Sample Program "<a href="https://github.com/cpjobling/EG-252-Resources/tree/master/Microcontroller-Interfacing/Exercises/Exercise3/tpm_motor.c">tpm_motor.c</a></h1>
<p>This sample C program is designed to generate PWM signals to drive two motors. The motor speeds are controlled by the PWM signal duty cycle (i.e., ‘on’ time with respect to a total period), while the motor directions (brake, forward and reverse etc) can be controlled by the logic levels of output signals to the motors.</p>
<p>With this sample program the motor direction is configured by the setting of the rocker switches. The motor speed is controlled by configuring the modulo registers and the channel value registers. The modulo registers determine the PWM signal period. Upon the timer overflow interrupt the motors are turned on and direction is set by writing to port G where the two motors are connected. Upon the output compare interrupt (when the free-running counter value matches that stored in the channel value registers, an output compare interrupt is generated if an interrupt is enabled for that channel) both motors are turned off.</p>
<p>Note that to drive the motor, an additional power supply is needed, which is available in the laboratory. Connect a 6-volt output to the demonstration board. Compile and run the sample program, you will be able to try different motor directions by setting the rocker switches accordingly.</p>
<p>In this sample program there is a main program (Listing 2: Lines 27–51) and two interrupt service routines (Listing 2: Lines 53–73). Use the MC9S08AW60 datasheet to find out the interrupt vectors for the TPM1 timer interrupt and TPM1 channel 1 interrupt. Again check the MC9S08AW60 datasheet to understand the configuration of the modulo register and IOC register.</p>
<div class="sourceCode" id="tpm_motor_c" data-include="tpm_motor.c"><pre class="sourceCode numberSource c numberLines"><code class="sourceCode c"><span id="tpm_motor_c-1"><a href="#tpm_motor_c-1"></a><span class="co">/*</span></span>
<span id="tpm_motor_c-2"><a href="#tpm_motor_c-2"></a></span>
<span id="tpm_motor_c-3"><a href="#tpm_motor_c-3"></a><span class="co">Modified test Programme for new AW60 teaching board thanks to contributions from</span></span>
<span id="tpm_motor_c-4"><a href="#tpm_motor_c-4"></a><span class="co">Dr Tim Davies.</span></span>
<span id="tpm_motor_c-5"><a href="#tpm_motor_c-5"></a></span>
<span id="tpm_motor_c-6"><a href="#tpm_motor_c-6"></a><span class="co">This version gives direction control of the two motors but with interrupts to</span></span>
<span id="tpm_motor_c-7"><a href="#tpm_motor_c-7"></a><span class="co">give PWM speed control.</span></span>
<span id="tpm_motor_c-8"><a href="#tpm_motor_c-8"></a></span>
<span id="tpm_motor_c-9"><a href="#tpm_motor_c-9"></a><span class="co">There are two interrupts: the timer overflow for TPM1 timer, which sets the</span></span>
<span id="tpm_motor_c-10"><a href="#tpm_motor_c-10"></a><span class="co">overflow frequency of 100 Hz with bus clock rate 4MHz, and TPM1 channel 1 for</span></span>
<span id="tpm_motor_c-11"><a href="#tpm_motor_c-11"></a><span class="co">turn off the motor. The motors are turned off individually to give individual</span></span>
<span id="tpm_motor_c-12"><a href="#tpm_motor_c-12"></a><span class="co">speed control if required.</span></span>
<span id="tpm_motor_c-13"><a href="#tpm_motor_c-13"></a></span>
<span id="tpm_motor_c-14"><a href="#tpm_motor_c-14"></a><span class="co">The lower four rocker switches 1-4 on Port A determine the direction of the two</span></span>
<span id="tpm_motor_c-15"><a href="#tpm_motor_c-15"></a><span class="co">motors, e.g. 00001010 is reverse both motors, 00000101 is forward both motors,</span></span>
<span id="tpm_motor_c-16"><a href="#tpm_motor_c-16"></a><span class="co">00000000 is braked.</span></span>
<span id="tpm_motor_c-17"><a href="#tpm_motor_c-17"></a></span>
<span id="tpm_motor_c-18"><a href="#tpm_motor_c-18"></a><span class="co">*/</span></span>
<span id="tpm_motor_c-19"><a href="#tpm_motor_c-19"></a></span>
<span id="tpm_motor_c-20"><a href="#tpm_motor_c-20"></a><span class="pp">#include </span><span class="im">&lt;hidef.h&gt;</span><span class="pp">      </span><span class="co">// for EnableInterrupts macro</span></span>
<span id="tpm_motor_c-21"><a href="#tpm_motor_c-21"></a><span class="pp">#include </span><span class="im">&quot;derivative.h&quot;</span><span class="pp"> </span><span class="co">// include peripheral declarations</span></span>
<span id="tpm_motor_c-22"><a href="#tpm_motor_c-22"></a></span>
<span id="tpm_motor_c-23"><a href="#tpm_motor_c-23"></a>byte DRIVE;</span>
<span id="tpm_motor_c-24"><a href="#tpm_motor_c-24"></a>byte MODCNTH = <span class="bn">0x4E</span>, MODCNTL = <span class="bn">0x20</span>;            <span class="co">// values for the modulo registers (0x4E20)</span></span>
<span id="tpm_motor_c-25"><a href="#tpm_motor_c-25"></a>byte INIT_CHNCNTH = <span class="bn">0x40</span>, INIT_CHNCNTL = <span class="bn">0x00</span>;  <span class="co">// set the IOC register to 0x3000 for output compare function</span></span>
<span id="tpm_motor_c-26"><a href="#tpm_motor_c-26"></a></span>
<span id="tpm_motor_c-27"><a href="#tpm_motor_c-27"></a><span class="dt">void</span> main(<span class="dt">void</span>)</span>
<span id="tpm_motor_c-28"><a href="#tpm_motor_c-28"></a>{</span>
<span id="tpm_motor_c-29"><a href="#tpm_motor_c-29"></a>    EnableInterrupts;   <span class="co">// enable interrupts</span></span>
<span id="tpm_motor_c-30"><a href="#tpm_motor_c-30"></a>    SOPT   = <span class="bn">0x00</span>;      <span class="co">// disable COP (watchtimer)</span></span>
<span id="tpm_motor_c-31"><a href="#tpm_motor_c-31"></a></span>
<span id="tpm_motor_c-32"><a href="#tpm_motor_c-32"></a>    <span class="co">// Init_GPIO init code </span></span>
<span id="tpm_motor_c-33"><a href="#tpm_motor_c-33"></a>    PTADD = <span class="bn">0x00</span>;   <span class="co">// set port A as inputs for the rocker switches.</span></span>
<span id="tpm_motor_c-34"><a href="#tpm_motor_c-34"></a>    PTAPE = <span class="bn">0xFF</span>;</span>
<span id="tpm_motor_c-35"><a href="#tpm_motor_c-35"></a>    PTFDD = <span class="bn">0xFF</span>;   <span class="co">// set port F as outputs for LEDs</span></span>
<span id="tpm_motor_c-36"><a href="#tpm_motor_c-36"></a>    PTGDD = <span class="bn">0xFF</span>;   <span class="co">// set port G as outputs for motor drive where motors are connected to.</span></span>
<span id="tpm_motor_c-37"><a href="#tpm_motor_c-37"></a>    PTGPE = <span class="bn">0xFF</span>;   <span class="co">// enable port G pullups for motor drive.</span></span>
<span id="tpm_motor_c-38"><a href="#tpm_motor_c-38"></a>   </span>
<span id="tpm_motor_c-39"><a href="#tpm_motor_c-39"></a>    <span class="co">// configure TPM module 1</span></span>
<span id="tpm_motor_c-40"><a href="#tpm_motor_c-40"></a>    TPM1SC   = <span class="bn">0x49</span>;  <span class="co">// format: TOF(0) TOIE(1) CPWMS(0) CLKSB(0) CLKSA(1) PS2(0) PS1(0) PS0(1)</span></span>
<span id="tpm_motor_c-41"><a href="#tpm_motor_c-41"></a>    TPM1MODH = MODCNTH; TPM1MODL = MODCNTL; <span class="co">// set the counter modulo registers to 0x4E20.</span></span>
<span id="tpm_motor_c-42"><a href="#tpm_motor_c-42"></a></span>
<span id="tpm_motor_c-43"><a href="#tpm_motor_c-43"></a>    <span class="co">// configure TPM1 channel 1</span></span>
<span id="tpm_motor_c-44"><a href="#tpm_motor_c-44"></a>    TPM1C1SC = <span class="bn">0x50</span>;     <span class="co">// TPM1 Channel 1</span></span>
<span id="tpm_motor_c-45"><a href="#tpm_motor_c-45"></a>    TPM1C1VH = INIT_CHNCNTH; TPM1C1VL = INIT_CHNCNTL;   <span class="co">// set the channel 1 registers to 0x4000</span></span>
<span id="tpm_motor_c-46"><a href="#tpm_motor_c-46"></a>  </span>
<span id="tpm_motor_c-47"><a href="#tpm_motor_c-47"></a>    <span class="cf">for</span>(;;) {</span>
<span id="tpm_motor_c-48"><a href="#tpm_motor_c-48"></a>        DRIVE = PTAD &amp; <span class="bn">0x0F</span>;		<span class="co">// read the motor direction settings from the rocker switches 1-4</span></span>
<span id="tpm_motor_c-49"><a href="#tpm_motor_c-49"></a>        PTFD = DRIVE;</span>
<span id="tpm_motor_c-50"><a href="#tpm_motor_c-50"></a>    }   <span class="co">// loop forever</span></span>
<span id="tpm_motor_c-51"><a href="#tpm_motor_c-51"></a>}</span>
<span id="tpm_motor_c-52"><a href="#tpm_motor_c-52"></a></span>
<span id="tpm_motor_c-53"><a href="#tpm_motor_c-53"></a>interrupt <span class="dv">11</span> <span class="dt">void</span> TPM1SC_overflow()</span>
<span id="tpm_motor_c-54"><a href="#tpm_motor_c-54"></a>{   <span class="co">// interrupt vector: Vtpm1</span></span>
<span id="tpm_motor_c-55"><a href="#tpm_motor_c-55"></a>    byte varClear;</span>
<span id="tpm_motor_c-56"><a href="#tpm_motor_c-56"></a>    </span>
<span id="tpm_motor_c-57"><a href="#tpm_motor_c-57"></a>    varClear = TPM1SC;  <span class="co">// 2 steps to clear timer interrupt flags</span></span>
<span id="tpm_motor_c-58"><a href="#tpm_motor_c-58"></a>    varClear = varClear &amp; <span class="bn">0x7F</span>;</span>
<span id="tpm_motor_c-59"><a href="#tpm_motor_c-59"></a>    TPM1SC = varClear;</span>
<span id="tpm_motor_c-60"><a href="#tpm_motor_c-60"></a></span>
<span id="tpm_motor_c-61"><a href="#tpm_motor_c-61"></a>    PTGD = DRIVE;       <span class="co">// turn on motors as configured by DRIVE (port A switches).</span></span>
<span id="tpm_motor_c-62"><a href="#tpm_motor_c-62"></a>}</span>
<span id="tpm_motor_c-63"><a href="#tpm_motor_c-63"></a></span>
<span id="tpm_motor_c-64"><a href="#tpm_motor_c-64"></a>interrupt <span class="dv">6</span> <span class="dt">void</span> TPM1C1SC_int()</span>
<span id="tpm_motor_c-65"><a href="#tpm_motor_c-65"></a>{   <span class="co">// interrupt vector: Vtpm1ch1</span></span>
<span id="tpm_motor_c-66"><a href="#tpm_motor_c-66"></a>    byte varClear;</span>
<span id="tpm_motor_c-67"><a href="#tpm_motor_c-67"></a></span>
<span id="tpm_motor_c-68"><a href="#tpm_motor_c-68"></a>    varClear = TPM1C1SC;    <span class="co">// 2 steps to clear timer interrupt flags</span></span>
<span id="tpm_motor_c-69"><a href="#tpm_motor_c-69"></a>    varClear = varClear &amp; <span class="bn">0x7F</span>;</span>
<span id="tpm_motor_c-70"><a href="#tpm_motor_c-70"></a>    TPM1C1SC = varClear;    </span>
<span id="tpm_motor_c-71"><a href="#tpm_motor_c-71"></a> </span>
<span id="tpm_motor_c-72"><a href="#tpm_motor_c-72"></a>    PTGD = PTGD | <span class="bn">0x0F</span>;     <span class="co">// set free-wheel mode for both motors instead of turn off</span></span>
<span id="tpm_motor_c-73"><a href="#tpm_motor_c-73"></a>}</span></code></pre></div>
<p>View on <a href="https://github.com/cpjobling/EG-252-Resources/blob/master/Microcontroller-Interfacing/Exercises/Exercise3/tpm_motor.c">GitHub</a></p>
<h2 id="iv.-task-4-pwm-duty-cycle-and-motor-speed-control">IV. Task 4: PWM Duty Cycle and Motor Speed Control</h2>
<p>For Task 4 you are required to modify the sample program in order to:</p>
<ul>
<li><p>Set the duty cycle of the two motors to xx%<em>, where <em>xx</em> is the leftmost two digits of your student number. For example, if your student number is 567890, you should set the duty cycle to 56%. In the sample program, only TPM1 channel 1 is used to control the duty cycle (and motor speed) for both motors, resulting identical speed for the two motors. </em>This part is worth 4 marks*.</p></li>
<li><p>Enable independent speed control of the two motors*: Use the leftmost two digits of your student number set the duty cycle of motor 1 and the rightmost two digits to set the speed of the second motor. For example, if your student number is 123450, you should set the duty cycle of two motors to 12% and 50%, respectively. You are expected to utilize another TPM1 channel (e.g. channel 0). Therefore two TPM1 channels are available for speed control, one channel per each motor. You should introduce another interrupt service routine for the new TPM1 channel and make changes to the interrupt service routine for TPM1 channel 1. <em>This part is worth 5 marks</em>.</p></li>
</ul>
<p>Listing 2 Interrupt service routines for timer overflow interrupt and output compare interrupt.</p>
<h2 id="appendix">Appendix</h2>
<h3 id="theory-of-dc-motor-speed-control">Theory of DC Motor Speed Control</h3>
<p>The speed of a DC motor is directly proportional to the supply voltage, so if we reduce the supply voltage from 12 volts to 6 volts, the motor will run at half the speed. How can this be achieved when the battery is fixed at 12 volts? The speed controller works by varying the average voltage sent to the motor. It could do this by simply adjusting the voltage sent to the motor, but this is quite inefficient to do. A better way is to switch the motor’s supply on and off very quickly. If the switching is fast enough, the motor doesn’t notice it, it only notices the average effect.</p>
<p>When you watch a film in the cinema, or the television, what you are actually seeing is a series of fixed pictures, which change rapidly enough that your eyes just see the average effect - movement. Your brain fills in the gaps to give an average effect. Now imagine a light bulb with a switch. When you close the switch, the bulb goes on and is at full brightness, say 100 watts. When you open the switch it goes off (0 watt). Now if you close the switch for a fraction of a second, then open it for the same amount of time, the filament won’t have time to cool down and heat up, and you will just get an average glow of 50 watts. This is how lamp dimmers work, and the same principle is used by speed controllers to drive a motor. When the switch is closed, the motor sees 12 volts, and when it is open it sees 0 volt. If the switch is open for the same amount of time as it is closed, the motor will see an average of 6 volts, and will run more slowly accordingly.</p>
<p>As the amount of time that the voltage is on increases compared with the amount of time that it is off, the average speed of the motor increases. This is the principle of switch mode speed control. Thus the speed is set by PWM.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>Refer to <a href="http://homepages.which.net/~paul.hills/SpeedControl/SpeedControllersBody.html">Speed Controllers</a> by Paul Hills for more details.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">EG-252 Resources</span> by <a xmlns:cc="http://creativecommons.org/ns#" href="http://www.swan.ac.uk" property="cc:attributionName" rel="cc:attributionURL">Swansea University</a> is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.

</div>
</section>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">EG-252-Resources maintained by <a href="https://github.com/cpjobling">cpjobling</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

</body>
</html>
